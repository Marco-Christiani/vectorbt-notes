<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-08-27 Sat 22:18 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vbt</title>
<meta name="author" content="John Doe" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Vbt</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgfa3778e">1. Useful Documentation</a></li>
<li><a href="#org51e6c3c">2. Topics</a>
<ul>
<li><a href="#org8b4c562">2.1. Questions</a></li>
<li><a href="#org984e0e6">2.2. Strategy Implementation Questions</a></li>
<li><a href="#orgca7c4d9">2.3. Flexible Indexing</a></li>
<li><a href="#orgc37d366">2.4. Broadcasting</a></li>
<li><a href="#org53b3449">2.5. Using Columns&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keyconcept">keyconcept</span></span></a></li>
<li><a href="#org697eccf">2.6. Grouping&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keyconcept">keyconcept</span></span></a></li>
<li><a href="#org318fe83">2.7. Call Hierarchy&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keyconcept">keyconcept</span></span></a>
<ul>
<li><a href="#org891d388">2.7.1. Movement patterns</a></li>
<li><a href="#org1cb193d">2.7.2. Blocks</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7bd25b6">3. Workflow Phases</a>
<ul>
<li><a href="#org4b2fe77">3.1. Preparation</a></li>
<li><a href="#org7a21d98">3.2. Simulation</a></li>
<li><a href="#org5f8f941">3.3. Construction</a></li>
<li><a href="#org9e80bd0">3.4. Analysis</a></li>
</ul>
</li>
<li><a href="#orgfb72ff1">4. simulate_nb()</a>
<ul>
<li><a href="#org991b8a8">4.1. Call Sequence</a>
<ul>
<li><a href="#org16024d4">4.1.1. Visualize Sequence</a></li>
</ul>
</li>
<li><a href="#orga95cf72">4.2. Signature</a></li>
<li><a href="#orgf0fede8">4.3. Callbacks</a>
<ul>
<li><a href="#org9def397">4.3.1. pre_sim_func_nb()</a></li>
<li><a href="#orgceb6094">4.3.2. post_sim_func_nb()</a></li>
<li><a href="#orgc4bbb19">4.3.3. pre_group_func_nb()</a></li>
<li><a href="#orgecf853f">4.3.4. post_group_func_nb()</a></li>
<li><a href="#org431c114">4.3.5. pre_segment_func_nb()</a></li>
<li><a href="#org1466858">4.3.6. post_segment_func_nb()</a></li>
<li><a href="#org3a12253">4.3.7. order_func_nb()</a></li>
<li><a href="#org8566d7d">4.3.8. post_order_func_nb()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd3a1d58">5. simulate_row_wise_nb()</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgfa3778e" class="outline-2">
<h2 id="orgfa3778e"><span class="section-number-2">1.</span> Useful Documentation</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><a href="https://vectorbt.dev/api/">Docs: Dev</a></li>
<li><a href="https://vectorbt.pro/tutorials/basic-rsi-strategy/">Docs: Pro (tutorials)</a></li>
<li><a href="https://vectorbt.dev/getting-started/resources/">Resources and Examples</a></li>
<li><a href="https://vectorbt.dev/api/portfolio/nb/">Vbt Numba Functions</a></li>
</ul>
</div>
</div>

<div id="outline-container-org51e6c3c" class="outline-2">
<h2 id="org51e6c3c"><span class="section-number-2">2.</span> Topics</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org8b4c562" class="outline-3">
<h3 id="org8b4c562"><span class="section-number-3">2.1.</span> Questions</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Have several unanswered questions about this thing.
</p>

<p>
Focusing on <code>from_order_func()</code> as its the most robust backtest flow.
</p>
<ul class="org-ul">
<li>Theres also a &ldquo;flexible&rdquo; version of <code>simulate_nb()</code></li>
<li><code>flex_simulate_nb()</code> allows multiple orders per symbol and bar</li>

<li>What is the final call sequence?</li>
<li>What does each function in the call sequence do?</li>
<li>What are &ldquo;groups&rdquo; and &ldquo;segments&rdquo;?</li>
<li>Document each Context enum type
<ul class="org-ul">
<li>What is <code>last_val_price</code> used for internally?</li>
<li>Examples online are modifiying internal state of passed contexts in the <code>_nb()</code> callbacks
<ul class="org-ul">
<li>i.e. modifying <code>last_val_price</code> in <code>pre_segment_func</code></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org984e0e6" class="outline-3">
<h3 id="org984e0e6"><span class="section-number-3">2.2.</span> Strategy Implementation Questions</h3>
<div class="outline-text-3" id="text-2-2">
<p>
What are best practices for sharing memory in functional programming paradigm
</p>
<ul class="org-ul">
<li>Passing around mutables appears to be necessary, and could get messy quick
<ul class="org-ul">
<li>Mutable since we have path dependent calculations</li>
<li>Best solution I can think of is using a structured data format (struct, namedtuple, etc) that stores mutables</li>
</ul></li>
<li>How can we retrieve this state after execution?
<ul class="org-ul">
<li>Need a reference from outer scope?</li>
<li>I feel like this is where Rust shines&#x2026;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgca7c4d9" class="outline-3">
<h3 id="orgca7c4d9"><span class="section-number-3">2.3.</span> Flexible Indexing</h3>
<div class="outline-text-3" id="text-2-3">
<p>
<a href="https://vectorbt.pro/features/#flexibility">Docs</a>
</p>
</div>
</div>
<div id="outline-container-orgc37d366" class="outline-3">
<h3 id="orgc37d366"><span class="section-number-3">2.4.</span> Broadcasting</h3>
<div class="outline-text-3" id="text-2-4">
<p>
<a href="https://vectorbt.pro/documentation/fundamentals/#broadcasting">Docs: Pro</a>
<a href="https://vectorbt.dev/api/portfolio/base/#flexible-indexing">Docs: Dev</a>
</p>

<p>
As a rule of thumb:
</p>
<ul class="org-ul">
<li>If any array is a Pandas object, always produces a Pandas object</li>
<li>If any array is two-dimensional, always produces a two-dimensional array</li>
<li>If all arrays are constants or one-dimensional, always produces a one-dimensional array</li>
<li>If any array is a DataFrame and this array is a one-dimensional NumPy array, broadcasts along columns</li>
<li>If this array is a Series, always broadcasts along rows</li>
<li>Lists and other sequences are converted to NumPy arrays prior to broadcasting</li>
</ul>
</div>
</div>
<div id="outline-container-org53b3449" class="outline-3">
<h3 id="org53b3449"><span class="section-number-3">2.5.</span> Using Columns&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keyconcept">keyconcept</span></span></h3>
<div class="outline-text-3" id="text-2-5">
<p>
<a href="https://vectorbt.pro/tutorials/basic-rsi-strategy/#using-columns">Docs</a>
</p>

<p>
Vectorbt is built around the idea that you can represent each asset, period, parameter combination, and a backtest in general, as a column in a two-dimensional array.
Instead of computing everything in a loop we can change our code to accept parameters as arrays.
A function that takes such array will automatically convert multiple parameters into multiple columns
</p>
</div>
</div>
<div id="outline-container-org697eccf" class="outline-3">
<h3 id="org697eccf"><span class="section-number-3">2.6.</span> Grouping&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keyconcept">keyconcept</span></span></h3>
<div class="outline-text-3" id="text-2-6">
<p>
<a href="https://vectorbt.dev/api/portfolio/base/#grouping">Docs</a>
</p>
</div>
</div>

<div id="outline-container-org318fe83" class="outline-3">
<h3 id="org318fe83"><span class="section-number-3">2.7.</span> Call Hierarchy&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keyconcept">keyconcept</span></span></h3>
<div class="outline-text-3" id="text-2-7">
<p>
See <a href="https://vectorbt.dev/api/portfolio/nb/#vectorbt.portfolio.nb.simulate_nb">simulate_nb() docs</a>
</p>

<p>
Based on an imaginary 2D frame
</p>
<ul class="org-ul">
<li>rows: time</li>
<li>columns: assets/features</li>
</ul>

<p>
Each element of the frame represents a potential order (determined by order function)
</p>

<p>
NOTE: You can only safely access data points that are to the left of the current group and rows that are to the top of the current row.
</p>
</div>

<div id="outline-container-org891d388" class="outline-4">
<h4 id="org891d388"><span class="section-number-4">2.7.1.</span> Movement patterns</h4>
<div class="outline-text-4" id="text-2-7-1">
<p>
In both patterns, we move top-to-bottom (time) and left-to-right (assets/features)
Differs in which axis moves faster
</p>
<ol class="org-ol">
<li>Column-Major: <code>simulate_nb()</code>
<ul class="org-ul">
<li>Process each column first</li>
<li>For when columns are independent</li>
</ul></li>
<li>Row-Major: <code>simulate_row_wise_nb()</code>
<ul class="org-ul">
<li>Process each row first</li>
<li>For when rows are independent?</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-org1cb193d" class="outline-4">
<h4 id="org1cb193d"><span class="section-number-4">2.7.2.</span> Blocks</h4>
<div class="outline-text-4" id="text-2-7-2">
<p>
Frame is divided into blocks:
</p>
<ul class="org-ul">
<li><b>Columns</b>: Assets/features</li>
<li><b>Groups:</b> Capital sharing?
<ul class="org-ul">
<li>I.e. Groups of columns that may or may not share capital</li>
</ul></li>
<li><b>Rows:</b> Time step</li>
<li><b>Segments:</b> Collections of groups within a group and time step
<ul class="org-ul">
<li>Each segment defines a call sequence to execute order</li>
</ul></li>
<li><b>Elements</b></li>
</ul>
<p>
Each block has:
</p>
<ul class="org-ul">
<li>Context: Its own context (passed to pre/post callbacks)</li>
<li>pre-processing callback function:
<ul class="org-ul">
<li>Called before entering the block</li>
<li>Returns a tuple</li>
<li>Tuple is unpacked and passed as arguments to next function in call hiearchy</li>
<li>I.e. Prepare arrays or do custom calculations</li>
</ul></li>
<li>post-processing callback function:
<ul class="org-ul">
<li>Called just before exiting block and moving to next function in call hiearchy</li>
<li>I.e. Write user-defined arrays such as returns</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org7bd25b6" class="outline-2">
<h2 id="org7bd25b6"><span class="section-number-2">3.</span> Workflow Phases</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://vectorbt.dev/api/portfolio/base/#workflow">Docs</a>
</p>
</div>
<div id="outline-container-org4b2fe77" class="outline-3">
<h3 id="org4b2fe77"><span class="section-number-3">3.1.</span> Preparation</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Occurs in a particular class method
</p>

<ul class="org-ul">
<li>Receives a set of inputs, such as signal arrays and other parameters</li>
<li>Resolves parameter defaults by searching for them in the global settings</li>
<li>Brings input arrays to a single shape</li>
<li>Does some basic validation of inputs and converts Pandas objects to NumPy arrays</li>
<li>Passes everything to a Numba-compiled simulation function</li>
</ul>
</div>
</div>

<div id="outline-container-org7a21d98" class="outline-3">
<h3 id="org7a21d98"><span class="section-number-3">3.2.</span> Simulation</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Occurs in numba simulation function
</p>

<p>
For each asset and timestamp (= element):
</p>
<ul class="org-ul">
<li>Gets all available information related to this element and executes the logic</li>
<li>Generates an order or skips the element altogether</li>
<li>If an order has been issued, processes the order and fills/ignores/rejects it</li>
<li>If the order has been filled, registers the result by appending it to the order records</li>
<li>Updates the current state such as the cash and asset balances</li>
</ul>
</div>
</div>
<div id="outline-container-org5f8f941" class="outline-3">
<h3 id="org5f8f941"><span class="section-number-3">3.3.</span> Construction</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Occurs in class method
</p>
<ul class="org-ul">
<li>Receives the returned order records and initializes a new Portfolio object</li>
</ul>
</div>
</div>
<div id="outline-container-org9e80bd0" class="outline-3">
<h3 id="org9e80bd0"><span class="section-number-3">3.4.</span> Analysis</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Occurs in <code>Portfolio</code> object
</p>
<ul class="org-ul">
<li>Offers a broad range of risk &amp; performance metrics based on order records</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgfb72ff1" class="outline-2">
<h2 id="orgfb72ff1"><span class="section-number-2">4.</span> simulate_nb()</h2>
<div class="outline-text-2" id="text-4">
<p>
<a href="https://vectorbt.dev/api/portfolio/nb/#vectorbt.portfolio.nb.simulate_nb">Docs</a>
</p>
</div>
<div id="outline-container-org991b8a8" class="outline-3">
<h3 id="org991b8a8"><span class="section-number-3">4.1.</span> Call Sequence</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li><code>pre_sim_func_nb(SimulationContext):</code> Before Simulation</li>
<li><code>post_sim_func_nb(SimulationContext):</code> After Simulation</li>
<li><code>pre_group_func_nb(GroupContext):</code> Before Group</li>
<li><code>post_group_func_nb(GroupContext):</code> After Group</li>
<li><code>pre_segment_func_nb(SegmentContext):</code> Before Segment</li>
<li><code>post_segment_func_nb(SegmentContext):</code> After Segment</li>
<li><code>order_func_nb(OrderContext):</code> Order</li>
<li><code>post_order_func_nb(PostOrderContext):</code> After Order</li>
</ul>


<div id="orgd601a4f" class="figure">
<p><img src="./assets/simulate_nb.gif" alt="simulate_nb.gif" />
</p>
<p><span class="figure-number">Figure 1: </span>simulate_nb call sequence</p>
</div>


<div id="orgb9a0d46" class="figure">
<p><img src="./assets/context_info.png" alt="context_info.png" />
</p>
<p><span class="figure-number">Figure 2: </span>context information</p>
</div>
</div>

<div id="outline-container-org16024d4" class="outline-4">
<h4 id="org16024d4"><span class="section-number-4">4.1.1.</span> Visualize Sequence</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Note that this changes for row-wise variation
Can be reordered to reflect the in-out sequence style
</p>

<ul class="org-ul">
<li><code>pre_sim_func_nb()</code>
<ul class="org-ul">
<li><code>pre_group_func_nb()</code>
<ul class="org-ul">
<li><code>pre_segment_func_nb()</code>
<ul class="org-ul">
<li><code>order_func_nb()</code></li>
<li><code>post_order_func_nb()</code></li>
</ul></li>
<li><code>post_segment_func_nb()</code></li>
</ul></li>
<li><code>post_group_func_nb()</code></li>
</ul></li>
<li><code>post_sim_func_nb()</code></li>
</ul>
</div>

<ol class="org-ol">
<li><a id="org98cbf02"></a>Sequence Order Example<br />
<div class="outline-text-5" id="text-4-1-1-1">
<p>
Below example is taken from <code>simulate_nb()</code> docs
</p>

<pre class="example" id="org54cae6a">
before simulation
    before group 0
        before segment 0
            creating order 0 at column 0
                order status: 0
            creating order 1 at column 1
                order status: 0
            creating order 2 at column 2
                order status: 0
        after segment 0
        before segment 2
            creating order 0 at column 1
                order status: 0
            creating order 1 at column 2
                order status: 0
            creating order 2 at column 0
                order status: 0
        after segment 2
        before segment 4
            creating order 0 at column 0
                order status: 0
            creating order 1 at column 2
                order status: 0
            creating order 2 at column 1
                order status: 0
        after segment 4
    after group 0
after simulation
</pre>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orga95cf72" class="outline-3">
<h3 id="orga95cf72"><span class="section-number-3">4.2.</span> Signature</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Scalars passed here are broadcast so that each row/group receives a copy.
</p>
<ul class="org-ul">
<li>i.e. Fees, call-seq, size, etc. can be custom set per row, this is actually neat</li>
</ul>

<div class="org-src-container">
<pre class="src src-python">simulate_nb(
    target_shape,
    group_lens,
    init_cash,
    cash_sharing,
    call_seq,
    segment_mask=array(<span style="color: #8be9fd;">True</span>),
    call_pre_segment=<span style="color: #8be9fd;">False</span>,
    call_post_segment=<span style="color: #8be9fd;">False</span>,
    pre_sim_func_nb=no_pre_func_nb,
    pre_sim_args=(),
    post_sim_func_nb=no_post_func_nb,
    post_sim_args=(),
    pre_group_func_nb=no_pre_func_nb,
    pre_group_args=(),
    post_group_func_nb=no_post_func_nb,
    post_group_args=(),
    pre_segment_func_nb=no_pre_func_nb,
    pre_segment_args=(),
    post_segment_func_nb=no_post_func_nb,
    post_segment_args=(),
    order_func_nb=no_order_func_nb,
    order_args=(),
    post_order_func_nb=no_post_func_nb,
    post_order_args=(),
    close=array(nan),
    ffill_val_price=<span style="color: #8be9fd;">True</span>,
    update_value=<span style="color: #8be9fd;">False</span>,
    fill_pos_record=<span style="color: #8be9fd;">True</span>,
    max_orders=<span style="color: #8be9fd;">None</span>,
    max_logs=<span style="color: #bd93f9; font-weight: bold;">0</span>,
    flex_2d=<span style="color: #8be9fd;">True</span>
)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf0fede8" class="outline-3">
<h3 id="orgf0fede8"><span class="section-number-3">4.3.</span> Callbacks</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org9def397" class="outline-4">
<h4 id="org9def397"><span class="section-number-4">4.3.1.</span> pre_sim_func_nb()</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
Use this to create temporary state arrays to get passed down the call stack
</p>
</div>
</div>
<div id="outline-container-orgceb6094" class="outline-4">
<h4 id="orgceb6094"><span class="section-number-4">4.3.2.</span> post_sim_func_nb()</h4>
</div>
<div id="outline-container-orgc4bbb19" class="outline-4">
<h4 id="orgc4bbb19"><span class="section-number-4">4.3.3.</span> pre_group_func_nb()</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
Same purpose as pre_sim_func_nb() but called at different time
</p>
</div>
</div>
<div id="outline-container-orgecf853f" class="outline-4">
<h4 id="orgecf853f"><span class="section-number-4">4.3.4.</span> post_group_func_nb()</h4>
</div>
<div id="outline-container-org431c114" class="outline-4">
<h4 id="org431c114"><span class="section-number-4">4.3.5.</span> pre_segment_func_nb()</h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
Use to set order prices and alter internal state (i.e. valuation price)
Also set call_seq order (i.e. have sells execute first)
</p>
</div>
</div>
<div id="outline-container-org1466858" class="outline-4">
<h4 id="org1466858"><span class="section-number-4">4.3.6.</span> post_segment_func_nb()</h4>
</div>
<div id="outline-container-org3a12253" class="outline-4">
<h4 id="org3a12253"><span class="section-number-4">4.3.7.</span> order_func_nb()</h4>
</div>
<div id="outline-container-org8566d7d" class="outline-4">
<h4 id="org8566d7d"><span class="section-number-4">4.3.8.</span> post_order_func_nb()</h4>
</div>
</div>
</div>

<div id="outline-container-orgd3a1d58" class="outline-2">
<h2 id="orgd3a1d58"><span class="section-number-2">5.</span> simulate_row_wise_nb()</h2>
<div class="outline-text-2" id="text-5">
<p>
pre_row_func_nb: only called if there is at least on active segment in the row.
pre_segment_func_nb/order_func_nb: only called if their segment is active.
If the main task of pre_row_func_nb is to activate/deactivate segments, all segments should be activated by default to allow pre_row_func_nb to be called.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: John Doe</p>
<p class="date">Created: 2022-08-27 Sat 22:18</p>
</div>
</body>
</html>
